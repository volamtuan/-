#!/bin/bash

# Installing necessary packages
echo "Installing necessary packages..."
if [ -f /etc/redhat-release ]; then
    yum -y install gcc net-tools bsdtar zip make curl wget nano >/dev/null 2>&1
elif [ -f /etc/debian_version ]; then
    apt-get update
    apt-get install gcc net-tools bsdtar zip make curl wget nano -y >/dev/null 2>&1
else
    echo "Unsupported OS"
    exit 1
fi
echo "Package installation complete."

# Checking for internet connection
echo "Kiểm tra kết nối mạng..."
ping -c 1 8.8.8.8 >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Không có kết nối mạng. Vui lòng kiểm tra lại kết nối và thử lại sau."
    exit 1
fi

# Detecting network interface
interface=$(ip link show | awk -F': ' '/^[0-9]+:/ {print $2}')
echo "Tên của card mạng là: $interface"
echo "Kiểm tra trạng thái giao diện mạng $interface..."
if ! ip link show "$interface" >/dev/null 2>&1; then
    echo "Giao diện mạng $interface không hoạt động."
    exit 1
fi

# Lấy địa chỉ IPv6
echo "Lấy địa chỉ IPv6 cho giao diện mạng $interface..."
IP6=$(ip -6 addr show "$interface" | grep -oP '(?<=inet6\s)[\da-f:]+' | grep -v ^::1 | head -n 1)
if [ -z "$IP6" ]; then
    echo "Không thể lấy địa chỉ IPv6 cho giao diện mạng $interface, thử sử dụng phương thức khác."
    IP6=$(curl -6 -s icanhazip.com)
fi

# Kiểm tra nếu không lấy được địa chỉ IPv6
if [ -z "$IP6" ]; then
    echo "Không thể lấy được địa chỉ IPv6 cho giao diện mạng $interface. Vui lòng kiểm tra kết nối mạng và thử lại sau."
    exit 1
fi

# Function to configure IPv6
configure_ipv6() {
    # CentOS configuration
    if [ -f /etc/sysconfig/network-scripts/ifcfg-"$interface" ]; then
        cat <<EOF >/etc/sysconfig/network-scripts/ifcfg-"$interface"
TYPE=Ethernet
NAME=$interface
DEVICE=$interface
ONBOOT=yes
BOOTPROTO=dhcp
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=eui64
IPADDR=$IP4
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=8.8.8.8
IPV6ADDR=$IP6/64
IPV6_DEFAULTGW=$IP6::1
EOF
        service network restart
    # Ubuntu configuration using Netplan
    elif [ -f /etc/netplan/01-netcfg.yaml ]; then
        cat <<EOF >/etc/netplan/01-netcfg.yaml
network:
  version: 2
  ethernets:
    $interface:
      dhcp4: true
      addresses:
        - $IP4/24
        - $IP6/64
      gateway4: 192.168.1.1
      gateway6: $IP6::1
      nameservers:
        addresses:
          - 8.8.8.8
          - 2001:4860:4860::8888
EOF
        sudo netplan apply
    else
        echo "Unsupported OS or missing network configuration files."
        exit 1
    fi

    echo "IPv6 configured as $IP6 for network interface $interface"
}

# Checking IPv6 connectivity
echo "Kiểm tra kết nối IPv6..."
ping6 -c 4 www.google.com

# Configuring IPv6
configure_ipv6
echo "Hoàn tất"
